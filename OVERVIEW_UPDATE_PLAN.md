# 全体分析タブ更新計画書（新セッション用）

## 📋 背景

### 現状
- `index.html` の全体分析タブ（`id="overview"`）のデータが古い
- 基本統計4つ（総販売数、総売上、平均価格、中央値）は既に手動更新済み
- **更新が必要な箇所**：
  1. 市場インサイトの文言（ブランド名と件数）
  2. ブランド別グラフデータ（JavaScriptの配列）
  3. 価格帯分布（現在は大まかな区分だが、実際は別の形式）

### 前回の失敗
- 全体分析タブの範囲を誤って特定し、パーツタブ、まとめ売りタブ、おすすめ出品順序タブを削除してしまった
- 原因：範囲の終了位置（閉じタグ `</div>`）の特定ミス

### 3者協議の結論
**「アンカーベースの外科的置換」を採用**
- 範囲指定は一切行わない
- 更新対象の「古い文字列」を一意に特定し、「新しい文字列」に置換
- 各置換ごとに検証を実施

---

## 🎯 最新データ（CSV: 13,710件）

### ブランド別販売数Top10
```
SEIKO: 7,524件
CASIO: 6,300件
Longines: 2,984件
(不明): 1,425件
OMEGA: 1,375件
GUCCI: 982件
CITIZEN: 897件
Tissot: 684件
Orient: 556件
ROLEX: 471件
```

### 駆動方式別販売数
```
不明: 10,278件
クオーツ: 6,881件
自動巻: 4,075件
ソーラー: 3,292件
デジタル: 870件
手巻き: 525件
スマートウォッチ: 73件
```

### 基本統計（既に更新済み）
- 総販売数: 26,168
- 総売上: $9,598,041
- 平均価格: $366.79
- 中央値: $192.40

---

## 📝 タスク分割（絶対に1つずつ実行）

### ⚠️ 重要な原則
1. **範囲指定を絶対に行わない**
2. **古い文字列を完全に特定してから置換**
3. **各タスク後に必ず検証**
4. **問題があれば即座に停止**

---

## タスク1: 事前確認（READ ONLY）

### 目的
更新対象の古い文字列を正確に特定する

### 実行内容
1. `index.html` の277行目付近から読み始める（`id="overview"`の開始位置）
2. 以下を確認：
   - 市場インサイトの正確な文言
   - ブランド別グラフのJavaScript配列（変数名を含む）
   - 価格帯分布のJavaScript配列（変数名を含む）

### 実行コマンド例
```python
# 277行目から100行読む
Read(file_path="index.html", offset=277, limit=100)
```

### 期待される出力
- 市場インサイトの古い文言（例：「CASIO (3813件) とSEIKO (3278件)」）
- グラフデータの変数名と配列

### 検証基準
- 文字列が一意に特定できている（他の場所に同じ文字列がない）
- 前後の文脈も含めて記録

**⚠️ このタスクでは何も変更しない。読み取りのみ。**

---

## タスク2: 市場インサイトの更新

### 目的
市場インサイトの文言を最新データに更新

### 実行前の確認
タスク1で特定した古い文言を確認：
```html
<li>🔝 最大カテゴリ: CASIO (3813件) とSEIKO (3278件) で市場の過半数を占める</li>
```

### 置換内容
**OLD（完全一致する文字列）**:
```html
                <li>🔝 最大カテゴリ: CASIO (3813件) とSEIKO (3278件) で市場の過半数を占める</li>
```

**NEW**:
```html
                <li>🔝 最大カテゴリ: SEIKO (7,524件) とCASIO (6,300件) で市場をリード</li>
```

### 実行コマンド
```python
Edit(
    file_path="index.html",
    old_string="<OLD文字列（上記）>",
    new_string="<NEW文字列（上記）>"
)
```

### 実行後の検証（必須）
1. 変更が1箇所だけ行われたことを確認
2. 他のタブが存在することを確認：
```bash
grep -c 'id="parts"' index.html    # 1が返るはず
grep -c 'id="bundle"' index.html   # 1が返るはず
grep -c 'id="recommend"' index.html # 1が返るはず
```

### 検証基準
- 上記3つのgrepが全て「1」を返す
- 新しい文言が正しく挿入されている

**⚠️ 検証に失敗したら即座に git revert で戻す**

---

## タスク3: ブランド別グラフデータの更新

### 目的
ブランド別販売数のJavaScript配列を最新データに更新

### 実行前の確認
タスク1で特定した古いグラフデータの配列を確認：
```javascript
const data = [{"labels": ["CASIO", "SEIKO", "OMEGA", "CITIZEN", "Orient", "TAG HEUER", "GUCCI", "ROLEX", "Hamilton", "Longines"], "values": [3813, 3278, 419, 361, 300, 230, 138, 106, 98, 90], "type": "pie"}];
```

### 一意性の確保
この配列が含まれる**前後の文脈を含めた大きなブロック**を置換対象とする。
例：
```javascript
    <script>
    const data = [{"labels": ["CASIO", "SEIKO", ...], "values": [3813, 3278, ...], "type": "pie"}];
    Plotly.newPlot('brandPieChart', data, ...);
    </script>
```

### 置換内容
**OLD（一意なブロック全体）**:
```javascript
（タスク1で特定した正確な文字列）
```

**NEW**:
```javascript
    const data = [{"labels": ["SEIKO", "CASIO", "Longines", "(不明)", "OMEGA", "GUCCI", "CITIZEN", "Tissot", "Orient", "ROLEX"], "values": [7524, 6300, 2984, 1425, 1375, 982, 897, 684, 556, 471], "type": "pie"}];
```

### 実行コマンド
```python
Edit(
    file_path="index.html",
    old_string="<OLD文字列（正確なブロック）>",
    new_string="<NEW文字列（上記）>"
)
```

### 実行後の検証（必須）
1. グラフが1箇所だけ更新されたことを確認
2. 他のタブが存在することを確認（タスク2と同じgrep）
3. JavaScriptエラーが出ていないことをブラウザで確認

### 検証基準
- grep結果が全て「1」
- ブラウザでグラフが正しく表示される

**⚠️ 検証に失敗したら即座に git revert で戻す**

---

## タスク4: 最終検証（READ ONLY）

### 目的
全ての更新が正しく反映され、他のタブが破壊されていないことを確認

### 実行内容
1. ブラウザで `http://localhost:8000/` を開く
2. 全てのタブをクリックして表示を確認：
   - ✅ 全体分析
   - ✅ 自動巻
   - ✅ クオーツ
   - ✅ ソーラー
   - ✅ 手巻き
   - ✅ スマートウォッチ
   - ✅ デジタル
   - ✅ **パーツ** ← 重要
   - ✅ **まとめ売り** ← 重要
   - ✅ **おすすめ出品順序** ← 重要
   - ✅ 各ブランドタブ

3. 全体分析タブの内容を確認：
   - 市場インサイト: "SEIKO (7,524件) とCASIO (6,300件)"
   - ブランド別グラフ: SEIKOとCASIOが上位に表示

### 検証基準
- 全タブが表示される
- 全体分析タブのデータが最新
- JavaScriptエラーが出ていない

---

## タスク5: Git Commit & Push

### 実行内容
```bash
git add index.html
git commit -m "fix: 全体分析タブの市場インサイトとブランド別グラフを最新データに更新

- 市場インサイト: SEIKO (7,524件) とCASIO (6,300件) に更新
- ブランド別グラフ: 最新Top10に更新
- アンカーベース置換により他タブへの影響なし
- パーツ、まとめ売り、おすすめ出品順序タブは保持

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git push
```

---

## 🚨 緊急時の対応

### 問題が発生した場合
```bash
# 即座に元に戻す
git revert HEAD --no-edit
git push
```

### ロールバック後の確認
```bash
grep -c 'id="parts"' index.html
grep -c 'id="bundle"' index.html
grep -c 'id="recommend"' index.html
```

全て「1」が返ることを確認。

---

## 📊 成功基準

### 最終的な状態
1. ✅ 全体分析タブのデータが最新
2. ✅ パーツタブが存在する
3. ✅ まとめ売りタブが存在する
4. ✅ おすすめ出品順序タブが存在する
5. ✅ 自動巻タブが存在する
6. ✅ JavaScriptエラーが出ていない
7. ✅ GitHub Pagesで正しく表示される

---

## 📝 新セッションへの指示

### 実行順序
1. この計画書を読む
2. タスク1から順番に実行
3. **各タスクで検証を実施**
4. **検証に失敗したら即座に停止**
5. 全タスクが成功したらGit commit & push

### 重要な注意事項
- **範囲指定は絶対に行わない**
- **古い文字列を完全に特定してから置換**
- **各タスクは独立して実行**
- **検証なしで次のタスクに進まない**

### 推奨されないアプローチ
❌ 全体分析タブ全体を置換
❌ 行範囲で置換
❌ ネストdivカウントで範囲特定
❌ 複数の変更を一度に実行

### 推奨されるアプローチ
✅ アンカーベースの外科的置換
✅ 一意な文字列を完全に特定
✅ 1つずつ実行、1つずつ検証
✅ 問題があれば即座に停止

---

## 🎯 この計画書の目的

この計画書は、**絶対にミスが起きないように**設計されています。

- 各タスクは独立しており、失敗しても局所的
- 検証が各ステップに組み込まれている
- 緊急時の対応が明確
- 新しいセッションでも実行可能

**新セッションの担当者へ**：この計画書に厳密に従ってください。創意工夫は不要です。指示通りに実行し、検証を怠らないでください。
